define(['underscore','./abstract','Magento_Ui/js/lib/key-codes','mage/translate','jquery'],function(_,Abstract,keyCodes,$t,$){'use strict';function parseOptions(nodes){var caption,value;nodes=_.map(nodes,function(node){value=node.value;if(value==null||value===''){if(_.isUndefined(caption)){caption=node.label;}}else{return node;}});return{options:_.compact(nodes),cacheOptions:_.compact(nodes)};}
return Abstract.extend({defaults:{options:[],listVisible:false,value:[],filterOptions:false,chipsEnabled:false,filterInputValue:'',filterOptionsFocus:false,multiselectFocus:false,selectedPlaceholders:{defaultPlaceholder:$t('Select...'),lotPlaceholders:$t('Selected')},hoverElIndex:null,listens:{listVisible:'cleanHoveredElement',filterInputValue:'filterOptionsList'}},initConfig:function(config){var result=parseOptions(config.options);_.extend(config,result);this._super();return this;},keyDownHandlers:function(){return{enterKey:this.enterKeyHandler,escapeKey:this.escapeKeyHandler,spaceKey:this.enterKeyHandler,pageUpKey:this.pageUpKeyHandler,pageDownKey:this.pageDownKeyHandler};},initObservable:function(){this._super();this.observe(['listVisible','hoverElIndex','placeholder','multiselectFocus','options','filterInputValue','filterOptionsFocus']);return this;},outerClick:function(){this.listVisible()?this.listVisible(false):false;},filterOptionsKeydown:function(data,event){var key=keyCodes[event.keyCode];!this.isTabKey(event)?event.stopPropagation():false;if(key==='pageDownKey'||key==='pageUpKey'){event.preventDefault();this.filterOptionsFocus(false);this.cacheUiSelect.focus();}
this.keydownSwitcher(data,event);return true;},filterOptionsList:function(){var i=0,array=[],curOption,value;this.options(this.cacheOptions);if(this.filterInputValue()){for(i;i<this.options().length;i++){curOption=this.options()[i].label.toLowerCase();value=this.filterInputValue().trim().toLowerCase();if(curOption.indexOf(value)>-1){array.push(this.options()[i]);}}
if(!value.length){this.options(this.cacheOptions);}else{this.options(array);}
this.cleanHoveredElement();}},removeSelected:function(value,data,event){event?event.stopPropagation():false;this.value.remove(value);},isTabKey:function(event){return keyCodes[event.keyCode]==='tabKey';},cleanHoveredElement:function(){if(!_.isNull(this.hoverElIndex())){this.hoverElIndex(null);}
return this;},isSelected:function(label){return _.contains(this.value(),label);},isHovered:function(index,elem){var status=this.hoverElIndex()===index;if(status&&elem.offsetTop>elem.parentNode.offsetHeight||status&&elem.parentNode.scrollTop>elem.offsetTop-elem.parentNode.offsetTop){elem.parentNode.scrollTop=elem.offsetTop-elem.parentNode.offsetTop;}
return status;},toggleListVisible:function(){this.listVisible(!this.listVisible());return this;},getValue:function(){var options=this.options(),selected=this.value();_.chain(options).pluck(options,'value').filter(function(opt){return _.contains(selected,opt);});},getSelected:function(){var selected=this.value();return this.cacheOptions.filter(function(opt){return _.contains(selected,opt.value);});},toggleOptionSelected:function(data){if(!_.contains(this.value(),data.value)){this.value.push(data.value);}else{this.value(_.without(this.value(),data.value));}
return this;},hasData:function(){if(!this.value()){this.value([]);}
return this.value()?!!this.value().length:false;},onMousemove:function(data,index,event){var target=$(event.target),id;if(this.isCursorPositionChange(event)){return false;}
target.is('li')?id=target.index():id=target.parent('li').index();id!==this.hoverElIndex()?this.hoverElIndex(id):false;this.setCursorPosition(event);},setCursorPosition:function(event){this.cursorPosition={x:event.pageX,y:event.pageY};},isCursorPositionChange:function(event){return this.cursorPosition&&this.cursorPosition.x===event.pageX&&this.cursorPosition.y===event.pageY;},onFocusIn:function(elem){!this.cacheUiSelect?this.cacheUiSelect=elem:false;this.multiselectFocus(true);},onFocusOut:function(){this.multiselectFocus(false);},enterKeyHandler:function(){if(this.listVisible()){if(!_.isNull(this.hoverElIndex())){this.toggleOptionSelected(this.options()[this.hoverElIndex()]);}}else{this.setListVisible(true);}},escapeKeyHandler:function(){this.listVisible()?this.setListVisible(false):false;},pageDownKeyHandler:function(){if(!_.isNull(this.hoverElIndex())){if(this.hoverElIndex()!==this.options().length-1){this.hoverElIndex(this.hoverElIndex()+1);}else{this.hoverElIndex(0);}}else{this.hoverElIndex(0);}},pageUpKeyHandler:function(){if(!_.isNull(this.hoverElIndex())){if(this.hoverElIndex()!==0){this.hoverElIndex(this.hoverElIndex()-1);}else{this.hoverElIndex(this.options().length-1);}}else{this.hoverElIndex(this.options().length-1);}},keydownSwitcher:function(data,event){var keyName=keyCodes[event.keyCode];if(this.isTabKey(event)){if(!this.filterOptionsFocus()&&this.listVisible()&&this.filterOptions){this.cacheUiSelect.blur();this.filterOptionsFocus(true);this.cleanHoveredElement();return false;}
this.listVisible(false);return true;}
if(this.keyDownHandlers().hasOwnProperty(keyName)){this.keyDownHandlers()[keyName].apply(this,arguments);}else{return true;}},setCaption:function(){var length;if(this.value()){length=this.value().length;}else{this.value([]);length=0;}
if(length>1){this.placeholder(length+' '+this.selectedPlaceholders.lotPlaceholders);}else if(length){this.placeholder(this.getSelected()[0].label);}else{this.placeholder(this.selectedPlaceholders.defaultPlaceholder);}
return this.placeholder();},setListVisible:function(value){this.listVisible(value);},getPreview:function(){var selected=this.getSelected();return selected.map(function(option){return option.label;}).join(', ');}});});